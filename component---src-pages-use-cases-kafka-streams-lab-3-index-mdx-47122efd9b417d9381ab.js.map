{"version":3,"sources":["webpack:///./src/pages/use-cases/kafka-streams/lab-3/index.mdx"],"names":["_frontmatter","makeShortcode","name","props","console","warn","InlineNotification","AnchorLinks","AnchorLink","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","mdxType","kind","parentName","isMDXComponent"],"mappings":"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","file":"component---src-pages-use-cases-kafka-streams-lab-3-index-mdx-47122efd9b417d9381ab.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/home/runner/work/refarch-eda/refarch-eda/docs/node_modules/gatsby-theme-carbon/src/templates/Default.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component '\" + name + \"' was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst InlineNotification = makeShortcode(\"InlineNotification\");\nconst AnchorLinks = makeShortcode(\"AnchorLinks\");\nconst AnchorLink = makeShortcode(\"AnchorLink\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <InlineNotification kind=\"warning\" mdxType=\"InlineNotification\">\n      <strong>TODO</strong> - Work in progress\n    </InlineNotification>\n    <AnchorLinks mdxType=\"AnchorLinks\">\n    <AnchorLink mdxType=\"AnchorLink\">Overview</AnchorLink>\n    <AnchorLink mdxType=\"AnchorLink\">Scenario Prerequisites</AnchorLink>\n    <AnchorLink mdxType=\"AnchorLink\">Develop the application</AnchorLink>\n    <AnchorLink mdxType=\"AnchorLink\">Integration Tests</AnchorLink>\n    <AnchorLink mdxType=\"AnchorLink\">Deploy to OpenShift</AnchorLink>\n    </AnchorLinks>\n    <h2>{`Overview`}</h2>\n    <ul>\n      <li parentName=\"ul\">{`In this lab scenario weâ€™re going to use `}<a parentName=\"li\" {...{\n          \"href\": \"https://quarkus.io\"\n        }}>{`Quarkus`}</a>{` to develop the core application with Kafka streams api and microprofile reactive messaging.`}</li>\n      <li parentName=\"ul\">{`We will be testing using `}<a parentName=\"li\" {...{\n          \"href\": \"https://kafka.apache.org/documentation/streams/\"\n        }}>{`Apache Kafka Streams`}</a>{` TestDriver to mimic a Topology, a Stream and Table.`}</li>\n    </ul>\n    <p>{`The requirements to address are:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`consume item sold from items topic, item has unique key. Item event has store information`}</li>\n      <li parentName=\"ul\">{`compute for each item its current stock cross store`}</li>\n      <li parentName=\"ul\">{`compute the store stock for each item`}</li>\n      <li parentName=\"ul\">{`generate inventory event for store - item - stock`}</li>\n      <li parentName=\"ul\">{`expose APIs to get stock for a store or for an item`}</li>\n    </ul>\n    <h2>{`Scenario Prerequisites`}</h2>\n    <p><strong parentName=\"p\">{`Java`}</strong></p>\n    <ul>\n      <li parentName=\"ul\">{`For the purposes of this lab we suggest Java 11+`}</li>\n    </ul>\n    <p><strong parentName=\"p\">{`Maven`}</strong></p>\n    <ul>\n      <li parentName=\"ul\">{`Maven will be needed for bootstrapping our application from the command-line and running\nour application.`}</li>\n    </ul>\n    <p><strong parentName=\"p\">{`An IDE of your choice`}</strong></p>\n    <ul>\n      <li parentName=\"ul\">{`Ideally an IDE that supports Quarkus (such as Visual Studio Code)`}</li>\n    </ul>\n    <p><strong parentName=\"p\">{`OpenShift Container Platform`}</strong></p>\n    <ul>\n      <li parentName=\"ul\">{`v4.4.x`}</li>\n    </ul>\n    <p><strong parentName=\"p\">{`IBM Cloud Pak for Integration`}</strong></p>\n    <ul>\n      <li parentName=\"ul\">{`CP4I2020.2`}</li>\n    </ul>\n    <p><strong parentName=\"p\">{`IBM Event Streams`}</strong></p>\n    <ul>\n      <li parentName=\"ul\">{`The section on use with Event Streams on CP4I assumes Event Streams v10. If using a previous version such as ESv2019.4.2, there are some differences to how you would configure `}<inlineCode parentName=\"li\">{`application.properties`}</inlineCode>{` to establish a connection.`}</li>\n    </ul>\n    <p><strong parentName=\"p\">{`Code Source`}</strong>{`: clone the following git repository: `}<inlineCode parentName=\"p\">{`git clone https://github.com/ibm-cloud-architecture/refarch-eda-item-inventory`}</inlineCode>{`.`}</p>\n    <p>{`The final source code is in this project: `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/ibm-cloud-architecture/refarch-eda-item-inventory\"\n      }}>{`https://github.com/ibm-cloud-architecture/refarch-eda-item-inventory`}</a>{`.`}</p>\n    <h2>{`Use application as-is`}</h2>\n    <p>{`If you do not want to develop the application, you can deploy it on OpenShift using our docker image. See the `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/ibm-cloud-architecture/refarch-eda-item-inventory\"\n      }}>{`repository readme`}</a>{` to do so.`}</p>\n    <h2>{`Develop the application`}</h2>\n    <h3>{`Setting up the Quarkus Application`}</h3>\n    <ul>\n      <li parentName=\"ul\">{`We will bootstrap the Quarkus application with the following Maven command (See `}<a parentName=\"li\" {...{\n          \"href\": \"https://quarkus.io/guides/maven-tooling#project-creation\"\n        }}>{`Quarkus maven tooling guide`}</a>{` for more information):`}</li>\n    </ul>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`mvn io.quarkus:quarkus-maven-plugin:1.7.2.Final:create \\\\\n    -DprojectGroupId=ibm.garage \\\\\n    -DprojectArtifactId=quarkus-kstreams-lab3 \\\\\n    -Dextensions=\"resteasy-jsonb,resteasy-mutiny,smallrye-health,quarkus-smallrye-openapi,openshift\"\n`}</code></pre>\n    <p>{`You can replace the `}<inlineCode parentName=\"p\">{`projectGroupId, projectArtifactId`}</inlineCode>{` fields as you like.`}</p>\n    <ul>\n      <li parentName=\"ul\">{`recall that is if you want to add an extension do something like: `}<inlineCode parentName=\"li\">{`./mvnw Quarkus:add-extension -Dextensions=\"kafka\"`}</inlineCode></li>\n    </ul>\n    <h3>{`Start the dev mode`}</h3>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`./mvnw quarkus:dev\n`}</code></pre>\n    <p>{`Going to the URL `}<a parentName=\"p\" {...{\n        \"href\": \"http://localhost:8080/\"\n      }}>{`http://localhost:8080/`}</a>{` will generate an exception, as we need to add configuration for Kafka-Streams.`}</p>\n    <p>{`Let add the minimum into the `}<inlineCode parentName=\"p\">{`application.properties`}</inlineCode></p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-properties\"\n      }}>{`quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n\nquarkus.log.console.level=INFO\nquarkus.log.console.enable=true\nquarkus.http.port=8080\nquarkus.swagger-ui.always-include=true\nquarkus.openshift.expose=true\n`}</code></pre>\n    <p>{`Now the application should display a basic web page. As we defined to use OpenAPI the following address should give us the API defined: `}<a parentName=\"p\" {...{\n        \"href\": \"http://localhost:8080/swagger-ui/#/default\"\n      }}>{`http://localhost:8080/swagger-ui/#/default`}</a>{`.`}</p>\n    <p>{`and health works too: `}<a parentName=\"p\" {...{\n        \"href\": \"http://localhost:8080/health\"\n      }}>{`http://localhost:8080/health`}</a></p>\n    <p>{`Let add a simple resource under the following package `}<inlineCode parentName=\"p\">{`ibm.garage.lab3.api`}</inlineCode></p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-java\"\n      }}>{`mport javax.enterprise.context.ApplicationScoped;\nimport javax.ws.rs.GET;\nimport javax.ws.rs.Path;\nimport javax.ws.rs.PathParam;\nimport javax.ws.rs.Produces;\nimport javax.ws.rs.core.MediaType;\n\nimport io.smallrye.mutiny.Uni;\nimport io.vertx.core.json.JsonObject;\n\n@ApplicationScoped\n@Path(\"/inventory\")\npublic class InventoryResource {\n    \n    @GET\n    @Path(\"/store/{storeID}\")\n    @Produces(MediaType.APPLICATION_JSON)\n    public  Uni<JsonObject> getStock(@PathParam(\"storeID\") String storeID) {\n            JsonObject stock = new JsonObject(\"{\\\\\"name\\\\\": \\\\\"hello you\\\\\", \\\\\"id\\\\\": \\\\\"\" + storeID + \"\\\\\"}\");\n            return Uni.createFrom().item( stock);\n    }\n}\n`}</code></pre>\n    <p>{`Outside of the traditional JAXRS annotation, we are using Uni class from `}<a parentName=\"p\" {...{\n        \"href\": \"https://smallrye.io/smallrye-mutiny/\"\n      }}>{`Mutiny`}</a>{` to get the API being asynchronous non-blocking.`}</p>\n    <p>{`A refresh `}<a parentName=\"p\" {...{\n        \"href\": \"http://localhost:8080/swagger-ui/\"\n      }}>{`http://localhost:8080/swagger-ui/`}</a>{` will get the new API which should work.`}</p>\n    <h3>{`Deploy to OpenShift using s2i`}</h3>\n    <p>{`Before going too far in the development, let deploy this simple app to OpenShift. We assume you are logged to the cluster via `}<inlineCode parentName=\"p\">{`oc login...`}</inlineCode></p>\n    <p>{`The following command should package the application and create OpenShift manifests, build a docker images and push it to OpenShift Private registry.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`./mvnw package -Dquarkus.kubernetes.deploy=true -Dquarkus.container-image.build=true\n`}</code></pre>\n    <p>{`It can take some seconds to build and deploy: `}<inlineCode parentName=\"p\">{`oc get pods -w`}</inlineCode>{` lets you see the build pods and the running app once the build is done. As we expose the application an OpenShift route was created. The url is at the end of the build output:\n`}<inlineCode parentName=\"p\">{`The deployed application can be accessed at: http://quarkus-kstreams-lab3...`}</inlineCode></p>\n    <p>{`For example this was the URL to access the swagger:`}</p>\n    <p><a parentName=\"p\" {...{\n        \"href\": \"http://quarkus-kstreams-lab3-jbsandbox.gse-eda-demo-2020-08-fa9ee67c9ab6a7791435450358e564cc-0000.us-south.containers.appdomain.cloud/swagger-ui/\"\n      }}>{`http://quarkus-kstreams-lab3-jbsandbox.gse-eda-demo-2020-08-fa9ee67c9ab6a7791435450358e564cc-0000.us-south.containers.appdomain.cloud/swagger-ui/`}</a></p>\n    <h3>{`Define the domain entities`}</h3>\n    <p>{`Under the `}<inlineCode parentName=\"p\">{`src/main/java/../domain`}</inlineCode>{` folder add the two classes representing the business entities we are using:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-Java\"\n      }}>{`public class Item {\n    public static String RESTOCK = \"RESTOCK\";\n    public static String SALE = \"SALE\";\n    public String storeName;\n    public String sku;\n    public int quantity;\n    public String type;\n    public Double price;\n    public String timestamp;\n\n    public Item(){}\n}\n`}</code></pre>\n    <p>{`This item will also being used for event structure on `}<inlineCode parentName=\"p\">{`items`}</inlineCode>{` topic. The type attribute is to specify if this is a sale event or a restock event.`}</p>\n    <p>{`The inventory per store includes a map of item.sku and quantity.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-Java\"\n      }}>{`public class Inventory {\n    public String storeName;\n    public HashMap<String,Long> stock = new HashMap<String,Long>();\n    public Inventory(){}\n}\n`}</code></pre>\n    <p>{`As part of the logic we want to add methods in the Inventory class to update the quantity given an item. So the two following methods are added`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-Java\"\n      }}>{`public Inventory updateStockQuantity(String k, Item newValue) {\n        this.storeName = k;\n        if (newValue.type.equals(\"SALE\")) \n            newValue.quantity=-newValue.quantity;\n        return this.updateStock(newValue.sku,newValue.quantity);\n    }\n\n    public Inventory updateStock(String sku, long newV) {\n        if (stock.get(sku) == null) {\n            stock.put(sku, Long.valueOf(newV));\n        } else {\n            Long currentValue = stock.get(sku);\n            stock.put(sku, Long.valueOf(newV) + currentValue );\n        }\n        return this;\n    }\n`}</code></pre>\n    <p>{`Modify the InventoryResource to return the inventory instead of JsonObject.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-java\"\n      }}>{`public  Uni<Inventory> getStock(@PathParam(\"storeID\") String storeID) {\n        Inventory stock = new Inventory();\n        stock.storeName = storeID;\n        Item newItem = new Item();\n        newItem.quantity = 10;\n        newItem.sku=\"item-01\";\n        newItem.type = Item.RESTOCK;\n        stock.updateStockQuantity(storeID, newItem);\n            return Uni.createFrom().item( stock);\n    }\n`}</code></pre>\n    <p>{`You should get a json like:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-json\"\n      }}>{`{\"stock\": {\n    \"item-01\": 10\n  },\n  \"storeName\": \"Store-A\"\n}\n`}</code></pre>\n    <p>{`We are good with the REST end point. Lets add Kafka-streams`}</p>\n    <h3>{`Add Kafka`}</h3>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`./mvnw Quarkus:add-extension -Dextensions=\"kafka,kafka-streams,smallrye-reactive-messaging-kafka\"\n`}</code></pre>\n    <p>{`Since we will be using the Kafka Streams testing functionality we will need to edit the `}<inlineCode parentName=\"p\">{`pom.xml`}</inlineCode>{` to add\nthe dependency to our project. Open `}<inlineCode parentName=\"p\">{`pom.xml`}</inlineCode>{` and add the following.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-xml\"\n      }}>{`<dependency>\n    <groupId>org.apache.kafka</groupId>\n    <artifactId>kafka-streams-test-utils</artifactId>\n    <version>2.5.0</version>\n    <scope>test</scope>\n</dependency>\n`}</code></pre>\n    <p>{`Modify the properties to add kafka, kafka-streams and reactive messaging parameters like`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-properties\"\n      }}>{`quarkus.kafka-streams.auto.offset.reset=latest\nquarkus.kafka-streams.health.enabled=true\nquarkus.kafka-streams.consumer.session.timeout.ms=7000\nquarkus.kafka-streams.consumer.heartbeat.interval.ms=200\nquarkus.kafka-streams.application-id=item-aggregator\nquarkus.kafka-streams.topics=items,inventory\n\nmp.messaging.incoming.item-channel.connector=smallrye-kafka\nmp.messaging.incoming.item-channel.topic=items\nmp.messaging.incoming.item-channel.group.id=item-aggregator\n`}</code></pre>\n    <h3>{`Define an item deserializer`}</h3>\n    <p>{`The item needs to be deserialized to a Item bean, so we add a new class:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-java\"\n      }}>{`import io.quarkus.kafka.client.serialization.JsonbDeserializer;\n\npublic class ItemDeserializer extends JsonbDeserializer<Item> {\n    public ItemDeserializer(){\n        // pass the class to the parent.\n        super(Item.class);\n    }\n}\n`}</code></pre>\n    <p>{`and a declaration in the properties file (change the class name if needed):`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-properties\"\n      }}>{`mp.messaging.incoming.item-channel.key.deserializer=org.apache.kafka.common.serialization.StringDeserializer\nmp.messaging.incoming.item-channel.value.deserializer=ibm.garage.lab3.infrastructure.ItemDeserializer\n`}</code></pre>\n    <h3>{`Define the topology`}</h3>\n    <p>{`While in dev mode, we can add the `}<inlineCode parentName=\"p\">{`StoreInventoryAgent`}</inlineCode>{` class under the infrastructure folder. This class will define the topology to consume messages from the `}<inlineCode parentName=\"p\">{`items`}</inlineCode>{` topic. The Serdes are class to support the serialization and deserialization of the beans we define as part of the event model.`}</p>\n    <p>{`We will start just by having a print out topology to get the plumbing done. So it will consume items topic:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-Java\"\n      }}>{`@ApplicationScoped\npublic class StoreInventoryAgent {\n    \n    public String itemSoldTopicName = \"items\";\n\n    private JsonbSerde<Item> itemSerde = new JsonbSerde<>(Item.class);\n   \n\n    public Topology buildTopology(){\n        StreamsBuilder builder = new StreamsBuilder();\n        \n        builder.stream(itemSoldTopicName, \n            Consumed.with(Serdes.String(), itemSerde))\n            .peek( (k,v) -> System.out.println(k));\n\n        return builder.build();\n    }\n}\n`}</code></pre>\n    <h3>{`Connect to Event Streams`}</h3>\n    <p>{`We need to complete the configuration to connect to the remote Event Streams running on OpenShift.`}</p>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Create the items and inventory topics, following the instructions as described `}{`[in this note]`}{`(../.. /overview/pre-requisites#creating-event-streams-topics) or using the following command:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`cloudctl es topic-create --name items --partitions 3 --replication-factor 3\ncloudctl es topic-create --name inventory --partitions 1 --replication-factor 3\ncloudctl es topics\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Get a user and scram-sha-512 password to remotely connect `}<a parentName=\"p\" {...{\n            \"href\": \"https://ibm.github.io/event-streams/getting-started/connecting/\"\n          }}>{`see product documentation`}</a>{` on how to do it, or use our `}<a parentName=\"p\" {...{\n            \"href\": \"http://localhost:8000/use-cases/overview/pre-requisites#get-shram-user\"\n          }}>{`quick summary here`}</a>{`.`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Get Server certificate. See our `}<a parentName=\"p\" {...{\n            \"href\": \"http://localhost:8000/use-cases/overview/pre-requisites#get-tls-server-public-certificate\"\n          }}>{`quick summary here`}</a></p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Modify the properties file to define the kafka connection properties:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-properties\"\n          }}>{`kafka.bootstrap.servers=\\${KAFKA_BROKERS}\nkafka.security.protocol=\\${SECURE_PROTOCOL}\nkafka.ssl.protocol=TLSv1.2\nkafka.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username\\\\=\\\\\"\\${KAFKA_USER}\\\\\" password\\\\=\\\\\"\\${KAFKA_PASSWORD}\\\\\";\nkafka.sasl.mechanism=SCRAM-SHA-512\nkafka.ssl.truststore.location=\\${KAFKA_CERT_PATH}\nkafka.ssl.truststore.password=\\${KAFKA_CERT_PWD}\nkafka.ssl.truststore.type=PKCS12\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Define a file like `}<inlineCode parentName=\"p\">{`.env`}</inlineCode>{` to set environment variables, and modify the settings accordingly`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{}}>{`KAFKA_BROKERS=minimal-prod-kafka-bootstrap-eventstreams....containers.appdomain.cloud:443\nKAFKA_USER=\nKAFKA_PASSWORD=\nKAFKA_CERT_PATH=\\${PWD}/certs/es-cert.p12\nKAFKA_CERT_PWD=\nSECURE_PROTOCOL=SASL_SSL\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`Restart the quarkus in dev mode`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-shell\"\n          }}>{`source .env\n./mvnw quarkus:dev\n`}</code></pre>\n        <p parentName=\"li\">{`normally you should not get any exception and a trace like`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{}}>{`   AdminClientConfig values: \n   bootstrap.servers = [minimal-prod-kafka-bootstrap-eventstreams.gse-.....containers.appdomain.cloud:443]\n   client.dns.lookup = default\n   client.id = \n   connections.max.idle.ms = 300000\n   default.api.timeout.ms = 60000\n   metadata.max.age.ms = 300000\n   metric.reporters = []\n   metrics.num.samples = 2\n   metrics.recording.level = INFO\n   metrics.sample.window.ms = 30000\n`}</code></pre>\n      </li>\n    </ul>\n    <h3>{`Complete the topology`}</h3>\n    <p>{`The requirements can be bullet listed as:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`out-topic: inventory: contains the invenory stock events.`}</li>\n      <li parentName=\"ul\">{`Ktable <storeID, <itemID, count> with store. To keep store inventory`}</li>\n      <li parentName=\"ul\">{`Interactive query to get data from store and expose the result as reactive REST resource.`}</li>\n    </ul>\n    <p>{`To update the buildTopology function by getting the store and build a Ktable`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-Java\"\n      }}>{` KTable<String,Inventory> inventory = builder.stream(itemSoldTopicName, \n                        Consumed.with(Serdes.String(), itemSerde))\n            // use store name as key\n            .map((k,v) ->  new KeyValue<>(v.storeName, v))\n            .groupByKey(Grouped.with(Serdes.String(),itemSerde))\n       \n`}</code></pre>\n    <p>{`Then the operation to take this <storeName, item> record and transform it to Inventory instance, and update existing inventory entry is the `}<inlineCode parentName=\"p\">{`aggregate`}</inlineCode>{` function:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-Java\"\n      }}>{`.aggregate(\n      () ->  new Inventory(), // initializer\n      (k , newItem, currentInventory) \n            -> currentInventory.updateStockQuantity(k,newItem), \n      Materialized.<String,Inventory,KeyValueStore<Bytes,byte[]>>as(StoreInventoryAgent.STOCKS_STORE_NAME)\n            .withKeySerde(Serdes.String())\n            .withValueSerde(inventorySerde));\n`}</code></pre>\n    <p>{`First row is to initialize new key, record with an empty Inventory object.\nThe second row is executed when a key is found (first key too), and update the currentInventory with the new quantity from the item. The outcome of this is a Ktable<storeName, Inventory>\nThe content is materialized in a store.`}</p>\n    <p>{`The update operation on the inventory is a simple hashmap update: `}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-Java\"\n      }}>{`// in Inventory Class\npublic Inventory updateStockQuantity(String k, Item newValue) {\n        this.storeName = k;\n        if (newValue.type.equals(\"SALE\")) \n            newValue.quantity=-newValue.quantity;\n        return this.updateStock(newValue.sku,newValue.quantity);\n    }\n\n    public Inventory updateStock(String sku, long newV) {\n        if (stock.get(sku) == null) {\n            stock.put(sku, Long.valueOf(newV));\n        } else {\n            Long currentValue = stock.get(sku);\n            stock.put(sku, Long.valueOf(newV) + currentValue );\n        }\n        return this;\n    }\n`}</code></pre>\n    <p>{`Finally the KTable is streamed out to the inventory topic:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-Java\"\n      }}>{`inventory.toStream()\n            .to(inventoryStockTopicName,\n                Produced.with(Serdes.String(),inventorySerde));\n      \n`}</code></pre>\n    <p>{`The KTable is also materialized as a store that can be accessed via an API like `}<inlineCode parentName=\"p\">{`/inventory/store/{storeid}/{itemid}`}</inlineCode>{` using interactive query.`}</p>\n    <p>{`As items topic can be partitioned, a REST call may not reach the good end points, as the local store may not have the expected queried key. So the code is using interactive query to get access to the local state stores or return a URL of a remote store where the records for the given key are.`}</p>\n    <h2>{`Integration tests`}</h2>\n    <p>{` For running the integration test, we propose to copy the e2e folder from the solution repository and follow the `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/ibm-cloud-architecture/refarch-eda-item-inventory#end-to-end-testing\"\n      }}>{`readme instructions section end-to-end-testing `}</a>{`.`}</p>\n    <h2>{`Deploy to OpenShift`}</h2>\n    <p>{`Be sure to have done `}<a parentName=\"p\" {...{\n        \"href\": \"../../overview/pre-requisites#getting-tls-authentication-from-event-streams-on-openshift\"\n      }}>{`the steps described here`}</a>{` to get user credentials and Server side certificate.\nWe need to define a config map manifest (src/main/kubernetes/configmap.yml) for the user and brokers internal URL. The userID used is one of the scram-sha-512 ones.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yaml\"\n      }}>{`apiVersion: v1\nkind: ConfigMap\nmetadata:\n   name: item-aggregator-cm\ndata:\n   KAFKA_USER: app-demo\n   SECURE_PROTOCOL: SASL_SSL\n   KAFKA_BROKERS: minimal-prod-kafka-bootstrap.eventstreams.svc:9093\n`}</code></pre>\n    <p>{`Configure it with `}<inlineCode parentName=\"p\">{`oc apply -f src/main/kubernetes/configmap.yml`}</inlineCode>{`.`}</p>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}